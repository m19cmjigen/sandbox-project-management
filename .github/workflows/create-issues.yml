name: Create GitHub Issues from Tickets

on:
  workflow_dispatch:  # 手動実行用

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Issues from Ticket Files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // チケットディレクトリのパス
            const ticketsDir = './tickets';

            // カテゴリとラベルのマッピング
            const categoryLabels = {
              'INFRA': 'infrastructure',
              'DB': 'database',
              'BACK': 'backend',
              'BATCH': 'batch-worker',
              'FRONT': 'frontend',
              'SEC': 'security',
              'TEST': 'testing',
              'DEPLOY': 'deployment',
              'DOC': 'documentation'
            };

            // 優先度ラベルのマッピング
            const priorityLabels = {
              '高': 'priority: high',
              '中': 'priority: medium',
              '低': 'priority: low'
            };

            // チケットファイルを取得（README.md以外）
            const files = fs.readdirSync(ticketsDir)
              .filter(file => file.endsWith('.md') && file !== 'README.md')
              .sort();

            console.log(`Found ${files.length} ticket files`);

            // 各チケットファイルを処理
            for (const file of files) {
              const filePath = path.join(ticketsDir, file);
              const content = fs.readFileSync(filePath, 'utf8');

              // タイトルを抽出（最初の# 行）
              const titleMatch = content.match(/^#\s+(.+)$/m);
              const title = titleMatch ? titleMatch[1] : file.replace('.md', '');

              // カテゴリを抽出
              const category = file.split('-')[0];
              const categoryLabel = categoryLabels[category] || 'enhancement';

              // 優先度を抽出
              const priorityMatch = content.match(/## 優先度\s*\n(.+)/);
              const priority = priorityMatch ? priorityMatch[1].trim() : '中';
              const priorityLabel = priorityLabels[priority] || 'priority: medium';

              // ラベル配列
              const labels = ['ticket', categoryLabel, priorityLabel];

              console.log(`Creating issue: ${title}`);
              console.log(`  Labels: ${labels.join(', ')}`);

              try {
                // GitHub Issue作成
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: content,
                  labels: labels
                });

                console.log(`  ✓ Created issue #${issue.data.number}`);

                // API Rate Limitを回避するため1秒待機
                await new Promise(resolve => setTimeout(resolve, 1000));

              } catch (error) {
                console.error(`  ✗ Failed to create issue: ${error.message}`);
              }
            }

            console.log('All issues created successfully!');
